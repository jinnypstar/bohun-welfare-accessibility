# -*- coding: utf-8 -*-
"""city_name_unification.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1zuE5pLIKAQ5K_yEZlXbb1mzjX6et8b0o
"""

import pandas as pd
import re

# 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
hospital_df = pd.read_csv("bohun_hospital_final.csv", encoding="cp949")
veteran_df = pd.read_csv("veteran_population_by_region.csv")

# 2. ìƒì„¸ì£¼ì†Œì—ì„œ 'êµ¬' ë˜ëŠ” 'êµ°' ì¶”ì¶œ
def extract_gu(address):
    if pd.isna(address):
        return None
    match = re.search(r'(\S+[êµ¬êµ°])', address)
    return match.group(1) if match else None

# 3. ë³‘ì› ë°ì´í„° ì§€ì—­í‚¤ ìƒì„±: ì‹œêµ°êµ¬ëª… + ìƒì„¸ì£¼ì†Œì—ì„œ ì¶”ì¶œí•œ êµ¬ëª… (ê³µë°± ì œê±°)
hospital_df['ë³‘ì›_ì§€ì—­í‚¤'] = hospital_df['ì‹œêµ°êµ¬ëª…'].str.replace(r'\s+', '', regex=True) + \
                             hospital_df['êµ¬_ìƒì„¸ì£¼ì†Œ'].fillna('')

# 4. ë³´í›ˆ ë°ì´í„°ì˜ ì‹œêµ°êµ¬ëª…ì—ì„œ ê´„í˜¸ ë‚´ìš© ì œê±°
def clean_area(area):
    return re.sub(r"\s*\(.*?\)", "", str(area)).strip()

veteran_df['veteran_ì§€ì—­í‚¤'] = veteran_df['ì‹œêµ°êµ¬ëª…'].apply(clean_area).str.replace(r'\s+', '', regex=True)

# 5. ë³‘ì› í†µê³„ ì§‘ê³„
hospital_stats = hospital_df.groupby('ë³‘ì›_ì§€ì—­í‚¤').agg(
    ë³‘ì›ìˆ˜=('ìœ„íƒë³‘ì›ëª…', 'count'),
    ì§„ë£Œê³¼ìˆ˜_í‰ê· =('ì§„ë£Œê³¼ìˆ˜', 'mean')
).reset_index()

# ğŸ‘‰ ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼
hospital_stats['ì§„ë£Œê³¼ìˆ˜_í‰ê· '] = hospital_stats['ì§„ë£Œê³¼ìˆ˜_í‰ê· '].round().astype(int)

# 6. ë³‘í•©
merged_df = pd.merge(veteran_df, hospital_stats, how='left',
                     left_on='veteran_ì§€ì—­í‚¤', right_on='ë³‘ì›_ì§€ì—­í‚¤')

# 7. ê²°ê³¼ ì €ì¥
merged_df[['ì§€ì—­ëª…', 'ì‹œêµ°êµ¬ëª…', 'ë³´í›ˆëŒ€ìƒììˆ˜', 'ë³‘ì›ìˆ˜', 'ì§„ë£Œê³¼ìˆ˜_í‰ê· ']].to_excel("ë³´í›ˆ_ë³‘ì›_í†µê³„_ìµœì¢…ê²°ê³¼.xlsx", index=False)